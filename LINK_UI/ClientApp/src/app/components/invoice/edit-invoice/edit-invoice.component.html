<div class="main-wrapper">
    <div class="wrapper dashboard-wrapper">
        <div class="my-container">
            <div class="master-body">
                <div class="title-container">
                    <div class="header-back-button" *ngIf="fromSummary">
                        <img src="assets/images/back-red.png" alt="back" (click)="returnToSummary()">
                    </div>
                    <h3 class="main-title">
                        {{ 'INVOICE_MODIFY.LBL_EDIT_INVOICE' | translate }}
                        <span class="audit-id">
                            {{invoiceBaseDetail.oldInvoiceNo}} ({{invoiceBaseDetail.invoiceStatus}}) </span>
                    </h3>
                </div>
                <div class="content-container quotation-container">
                    <div class="container-head">
                        <img class="head-icon" src="assets/images/general.png" alt="">
                        {{ 'INVOICE_MODIFY.LBL_MAIN_DETAILS' | translate }}

                    </div>
                    <div class="row formPadding">
                        <div class="col-sm-12">
                            <div class="row marginTop15">
                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <a *ngIf="invoiceBaseDetail.invoiceNo!=invoiceBaseDetail.oldInvoiceNo"
                                            (click)="checkInvoiceExists()" class="right-link">
                                            <img src="assets/images/red-question.png" style="width: 13px;" alt="">
                                            {{ 'INVOICE_MODIFY.LBL_CHECK' | translate }}
                                        </a>
                                        <label class="required">{{ 'INVOICE_MODIFY.LBL_INVOICE_NO' | translate
                                            }}</label>
                                        <input maxlength="200" [(ngModel)]="invoiceBaseDetail.invoiceNo"
                                            [ngClass]="{ 'is-invalid':  !validator.isValid('invoiceNo')}" type="text" />
                                        <div *ngIf="!validator.isValid('invoiceNo')" class="invalid-feedback">
                                            <div *ngFor="let error of validator.getErrors('invoiceNo')">
                                                {{ error | translate }}
                                            </div>
                                        </div>

                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label for="" class="required">{{ 'INVOICE_MODIFY.LBL_INVOICE_DATE' | translate
                                            }}</label>
                                        <div class="calendar-wrapper">
                                            <input type="text" container="body"
                                                [ngClass]="{ 'is-invalid':  !validator.isValid('invoiceDate')}"
                                                readonly=readonly [(ngModel)]="invoiceBaseDetail.invoiceDate"
                                                ngbDatepicker #sdt1="ngbDatepicker" (click)="sdt1.toggle()">
                                            <img src="assets/images/calendar-icon.svg" alt="" class="calendar-icon"
                                                (click)="sdt1.toggle()">
                                        </div>
                                        <div *ngIf="!validator.isValid('invoiceDate')" class="invalid-feedback">
                                            <div *ngFor="let error of validator.getErrors('invoiceDate')">
                                                {{ error | translate }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label for="" class="required">{{ 'INVOICE_MODIFY.LBL_POST_DATE' | translate
                                            }}</label>
                                        <div class="calendar-wrapper">
                                            <input type="text" container="body"
                                                [ngClass]="{ 'is-invalid':  !validator.isValid('postDate')}"
                                                readonly=readonly [(ngModel)]="invoiceBaseDetail.postDate" ngbDatepicker
                                                #sdt2="ngbDatepicker" (click)="sdt2.toggle()">
                                            <img src="assets/images/calendar-icon.svg" alt="" class="calendar-icon"
                                                (click)="sdt2.toggle()">
                                        </div>
                                        <div *ngIf="!validator.isValid('postDate')" class="invalid-feedback">
                                            <div *ngFor="let error of validator.getErrors('postDate')">
                                                {{ error | translate }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">

                                    <div class="my-input-group">
                                        <label class="required">{{ 'INVOICE_MODIFY.LBL_BILLING_TO' | translate
                                            }}</label>
                                        <ng-select [items]="masterData.billingToList" [closeOnSelect]="true"
                                            [searchable]="true" bindLabel="name" bindValue="id" [disabled]="true"
                                            placeholder="--- {{(masterData.billingToList && masterData.billingToList.length>0? 'COMMON.LBL_SELECT':'COMMON.LBL_NO_DATA')  | translate }} ---"
                                            [loading]="masterData.billingToLoading"
                                            [(ngModel)]="invoiceBaseDetail.billTo" (change)="changeBillTo()"
                                            [ngClass]="{ 'is-invalid': !validator.isValid('billTo')}">
                                            <ng-template ng-option-tmp let-item="item">
                                                <div class="text-wrap">{{ item.name }}</div>
                                            </ng-template>
                                        </ng-select>
                                        <div *ngIf="!validator.isValid('billTo')" class="invalid-feedback">
                                            <div *ngFor="let error of validator.getErrors('billTo')">
                                                {{ error | translate }}
                                            </div>
                                        </div>
                                    </div>

                                </div>

                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="row marginTop25">

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label class="required">{{ 'INVOICE_MODIFY.LBL_BILLING_METHOD' | translate
                                            }}</label>
                                        <ng-select [items]="masterData.billingMethodList" [disabled]="true"
                                            [(ngModel)]="invoiceBaseDetail.billMethod" [closeOnSelect]="true"
                                            [searchable]="true" bindLabel="name" bindValue="id"
                                            placeholder="--- {{(masterData.billingMethodList && masterData.billingMethodList.length>0? 'COMMON.LBL_SELECT':'COMMON.LBL_NO_DATA')  | translate }} ---"
                                            [loading]="masterData.billingToLoading"
                                            [ngClass]="{ 'is-invalid': !validator.isValid('billMethod')}">
                                            <ng-template ng-option-tmp let-item="item">
                                                <div class="text-wrap">{{ item.name }}</div>
                                            </ng-template>
                                        </ng-select>
                                        <div *ngIf="!validator.isValid('billMethod')" class="invalid-feedback">
                                            <div *ngFor="let error of validator.getErrors('billMethod')">
                                                {{ error | translate }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label for="">{{ 'INVOICE_MODIFY.LBL_BILLED_NAME' | translate }}</label>
                                        <div class="calendar-wrapper">
                                            <input maxlength="200" [(ngModel)]="invoiceBaseDetail.billedName"
                                                type="text" />
                                        </div>

                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label>{{ 'INVOICE_MODIFY.LBL_BILLED_ADDRESS' | translate }}</label>
                                        <ng-select [items]="masterData.billingAddressList" [closeOnSelect]="true"
                                            [searchable]="true" bindLabel="name" bindValue="id"
                                            (change)="changeBillingAddress($event)"
                                            placeholder="--- {{(masterData.billingAddressList && masterData.billingAddressList.length>0? 'COMMON.LBL_SELECT':'COMMON.LBL_NO_DATA')  | translate }} ---"
                                            [loading]="masterData.invoiceBilledAddressLoading">
                                            <ng-template ng-option-tmp let-item="item">
                                                <div class="text-wrap">{{ item.name }}</div>
                                            </ng-template>
                                        </ng-select>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label class="required">{{ 'INVOICE_MODIFY.LBL_BILLED_ADDRESS_VALUE' | translate
                                            }}</label>

                                        <textarea style="height: 45px;" maxlength="500"
                                            [(ngModel)]="invoiceBaseDetail.billedAddress"
                                            [ngClass]="{ 'is-invalid': !validator.isValid('billedAddress')}"
                                            type="text"></textarea>

                                        <!--  <input maxlength="200" [(ngModel)]="invoiceBaseDetail.billedAddress"
                                            [ngClass]="{ 'is-invalid': !validator.isValid('billedAddress')}"
                                            type="text" /> -->
                                    </div>
                                    <div *ngIf="!validator.isValid('billedAddress')" class="invalid-feedback"
                                        style="display:block">
                                        <div *ngFor="let error of validator.getErrors('billedAddress')">
                                            {{ error | translate }}
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="col-sm-12">
                            <div class="row marginTop25">

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label for="" class="required">{{ 'INVOICE_MODIFY.LBL_CONTACTS' | translate
                                            }}</label>
                                        <ng-select [items]="masterData.contacts" bindLabel="name" class="multiple"
                                            bindValue="id" [multiple]="true" [closeOnSelect]="true" [searchable]="true"
                                            [loading]=masterData.invoiceContactsLoading [hideSelected]="true"
                                            [ngClass]="{ 'is-invalid':  !validator.isValid('contactIds')}"
                                            placeholder="--- {{ (masterData.contacts!=null && masterData.contacts.length!=0? 'EDIT_BOOKING.LBL_SELECT':'EDIT_BOOKING.MSG_NO_DATA' ) | translate }} ---"
                                            [(ngModel)]="invoiceBaseDetail.contactIds" appendTo="body">
                                            <ng-template ng-option-tmp let-item="item">
                                                <div class="text-wrap">{{ item.name }}</div>
                                            </ng-template>
                                        </ng-select>
                                        <div *ngIf="!validator.isValid('contactIds')" class="invalid-feedback"
                                            style="display:block">
                                            <div *ngFor="let error of validator.getErrors('contactIds')">
                                                {{ error | translate }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label>{{ 'INVOICE_MODIFY.LBL_PAYMENT_TERMS' | translate }}</label>
                                        <ng-select [items]="masterData.invoicePaymentTermList" [closeOnSelect]="true"
                                            [searchable]="true" bindLabel="name" bindValue="id"
                                            placeholder="--- {{(masterData.invoicePaymentTermList && masterData.invoicePaymentTermList.length>0? 'COMMON.LBL_SELECT':'COMMON.LBL_NO_DATA')  | translate }} ---"
                                            [loading]="masterData.invoicePaymentTermsLoading"
                                            (change)="changePaymentTerms($event)">
                                            <ng-template ng-option-tmp let-item="item">
                                                <div class="text-wrap">{{ item.name }}</div>
                                            </ng-template>
                                        </ng-select>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label class="required">{{ 'INVOICE_MODIFY.LBL_PAYMENTS_TERM_VALUE' | translate
                                            }}</label>
                                        <textarea maxlength="500" style="height: 45px;"
                                            [(ngModel)]="invoiceBaseDetail.paymentTerms"
                                            [ngClass]="{ 'is-invalid': !validator.isValid('paymentTerms')}"
                                            type="text"></textarea>
                                    </div>
                                    <div *ngIf="!validator.isValid('paymentTerms')" class="invalid-feedback"
                                        style="display:block">
                                        <div *ngFor="let error of validator.getErrors('paymentTerms')">
                                            {{ error | translate }}
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label class="required">{{ 'INVOICE_MODIFY.LBL_PAYMENT_DURATION' | translate
                                            }}</label>
                                        <input maxlength="200" [(ngModel)]="invoiceBaseDetail.paymentDuration"
                                            [ngClass]="{ 'is-invalid':  !validator.isValid('paymentDuration')}"
                                            type="text" />
                                    </div>
                                    <div *ngIf="!validator.isValid('paymentDuration')" class="invalid-feedback"
                                        style="display:block">
                                        <div *ngFor="let error of validator.getErrors('paymentDuration')">
                                            {{ error | translate }}
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="col-sm-12">
                            <div class="row marginTop25">

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label class="required">{{ 'INVOICE_MODIFY.LBL_OFFICE' | translate }}</label>
                                        <ng-select [items]="masterData.invoiceOfficeList"
                                            [(ngModel)]="invoiceBaseDetail.office" [closeOnSelect]="true"
                                            [searchable]="true" bindLabel="name" bindValue="id"
                                            placeholder="--- {{(masterData.invoiceOfficeList && masterData.invoiceOfficeList.length>0? 'COMMON.LBL_SELECT':'COMMON.LBL_NO_DATA')  | translate }} ---"
                                            [loading]="masterData.invoicePaymentTermsLoading"
                                            [ngClass]="{ 'is-invalid': !validator.isValid('office')}">
                                            <ng-template ng-option-tmp let-item="item">
                                                <div class="text-wrap">{{ item.name }}</div>
                                            </ng-template>
                                        </ng-select>
                                        <div *ngIf="!validator.isValid('office')" class="invalid-feedback">
                                            <div *ngFor="let error of validator.getErrors('office')">
                                                {{ error | translate }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label>{{ 'INVOICE_MODIFY.LBL_BANK_DETAILS' | translate }}</label>
                                        <textarea maxlength="200" style="height: 45px;"
                                            [(ngModel)]="masterData.bankDetails" [disabled]="true"
                                            type="text"></textarea>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label class="required">{{ 'INVOICE_MODIFY.LBL_PAYMENT_STATUS' | translate
                                            }}</label>
                                        <ng-select [items]="masterData.invoicePaymentStatusList"
                                            [(ngModel)]="invoiceBaseDetail.paymentStatus" [closeOnSelect]="true"
                                            [searchable]="true" bindLabel="name" bindValue="id"
                                            placeholder="--- {{(masterData.invoicePaymentStatusList && masterData.invoicePaymentStatusList.length>0? 'COMMON.LBL_SELECT':'COMMON.LBL_NO_DATA')  | translate }} ---"
                                            [loading]="masterData.invoicePaymentStatusLoading"
                                            [ngClass]="{ 'is-invalid': !validator.isValid('paymentStatus')}">
                                            <ng-template ng-option-tmp let-item="item">
                                                <div class="text-wrap">{{ item.name }}</div>
                                            </ng-template>
                                        </ng-select>
                                        <div *ngIf="!validator.isValid('paymentStatus')" class="invalid-feedback">
                                            <div *ngFor="let error of validator.getErrors('paymentStatus')">
                                                {{ error | translate }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label for="">{{ 'INVOICE_MODIFY.LBL_PAYMENT_DATE' | translate }}</label>
                                        <div class="calendar-wrapper">
                                            <input type="text" container="body"
                                                [ngClass]="{ 'is-invalid':  !validator.isValid('paymentDate')}"
                                                readonly=readonly [(ngModel)]="invoiceBaseDetail.paymentDate"
                                                ngbDatepicker #sdt3="ngbDatepicker" (click)="sdt3.toggle()">
                                                <img src="assets/images/cta-close-grey.svg" alt="" class="close-icon"
                                                (click)="clearDateInput('paymentDate');" *ngIf="invoiceBaseDetail.paymentDate">
                                            <img src="assets/images/calendar-icon.svg" alt="" class="calendar-icon"
                                                (click)="sdt3.toggle()">
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="col-sm-12">
                            <div class="row marginTop25">
                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label>{{ 'INVOICE_MODIFY.LBL_SUBJECT' | translate }}</label>
                                        <textarea style="height: 45px;" maxlength="500"
                                            [(ngModel)]="invoiceBaseDetail.subject" type="text"></textarea>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                        <label class="control-label required">{{ 'EDIT_CUSTOMER.LBL_INVOICE_TYPE' |
                                            translate }}</label>
                                        <ng-select [items]="masterData.invoiceTypeList" [disabled]="true"
                                            [(ngModel)]="invoiceBaseDetail.invoiceType" [closeOnSelect]="true"
                                            [searchable]="true" bindLabel="name" bindValue="id"
                                            placeholder="--- {{(masterData.invoiceTypeList && masterData.invoiceTypeList.length>0? 'COMMON.LBL_SELECT':'COMMON.LBL_NO_DATA')  | translate }} ---"
                                            [loading]="masterData.invoiceTypeLoading"
                                            [ngClass]="{ 'is-invalid': !validator.isValid('invoiceType')}">
                                            <ng-template ng-option-tmp let-item="item">
                                                <div class="text-wrap">{{ item.name }}</div>
                                            </ng-template>
                                        </ng-select>
                                        <div *ngIf="!validator.isValid('invoiceType')" class="invalid-feedback">
                                            <div *ngFor="let error of validator.getErrors('invoiceType')">
                                                {{ error | translate }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                    <label class="light" for="">Billed Quantity</label>
                                    <p style="padding-top: 5px;" class="input-value">{{invoiceBaseDetail.billedQuantityType}}</p>
                                    </div>
                                </div>

                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <div class="my-input-group">
                                    <label  class="light" for="">Invoice Currency</label>
                                    <p style="padding-top: 5px;" class="input-value">{{invoiceBaseDetail.invoiceCurrencyName}}</p>
                                    </div>
                                </div>

                            </div>
                        </div>


                        <div class="col-sm-12 marginTop25 section-container booking-result">

                            <button class="secondary-cta small absolute-button"
                                (click)="addNewBookingToInvoice(invoiceToNewBooking)">+

                                Add Booking</button>

                            <div class="table-container marginTop15"
                                style="overflow-x: scroll;overflow-y: scroll; max-height: 600px;">
                                <table class="pagination-table simple-table bordered">
                                    <thead>
                                        <tr class="sticky-top-row">
                                            <th *ngIf="serviceId==1"></th>
                                            <th class="sticky-left-column">
                                                {{ 'INVOICE_MODIFY.LBL_BOOKING_CUSTOMER_NO' | translate }}
                                            </th>

                                            <th>{{ 'INVOICE_MODIFY.LBL_QUOTATION' | translate }}</th>
                                            <th>
                                                {{ 'INVOICE_MODIFY.LBL_SERVICE_DATE_FROM_TO' | translate }}</th>
                                            <th>{{ 'INVOICE_MODIFY.LBL_SERVICE_TYPE' | translate }}
                                            </th>

                                            <th>{{ 'INVOICE_MODIFY.LBL_CUSTOMER' | translate }}</th>

                                            <th>{{ 'INVOICE_MODIFY.LBL_SUPPLIER' | translate }}</th>
                                            <th>{{ 'INVOICE_MODIFY.LBL_FACTORY' | translate }}</th>
                                            <th>
                                                {{ 'INVOICE_MODIFY.LBL_FACTORY_LOCATION' | translate }}</th>
                                            <th *ngIf="serviceId==1">{{ 'INVOICE_MODIFY.LBL_PRICE_CATEGORY' | translate
                                                }}</th>
                                            <th *ngIf="serviceId==1">
                                                {{ 'INVOICE_MODIFY.LBL_TOTAL_BOOKING_QTY' | translate }}
                                            </th>
                                            <th *ngIf="serviceId==1">
                                                {{ 'INVOICE_MODIFY.LBL_TOTAL_INSPECTED_QTY' | translate }}</th>
                                                <th *ngIf="serviceId==1">
                                                    {{ 'INVOICE_MODIFY.LBL_TOTAL_PRESENTED_QTY' | translate }}</th>
                                            <th>{{ 'INVOICE_MODIFY.LBL_MAN_DAY' | translate }}</th>
                                            <th>{{ 'INVOICE_MODIFY.LBL_UNIT_PRICE' | translate }}</th>
                                            <th>{{ 'INVOICE_MODIFY.LBL_INSPECTION_FEES' | translate }}</th>
                                            <th>{{ 'INVOICE_MODIFY.LBL_AIR_COST' | translate }}</th>
                                            <th>{{ 'INVOICE_MODIFY.LBL_LAND_COST' | translate }}</th>
                                            <th>{{ 'INVOICE_MODIFY.LBL_OTHER_TRAVEL_COST' | translate }}</th>
                                            <th>{{ 'INVOICE_MODIFY.LBL_HOTEL_COST' | translate }}</th>
                                            <th>{{ 'INVOICE_MODIFY.LBL_OTHER_COST' | translate }}</th>
                                            <th>{{'INVOICE_SUMMARY.LBL_EXTRA_TOTAL' | translate}}
                                            </th>
                                            <th>{{ 'INVOICE_MODIFY.LBL_DISCOUNT' | translate }}</th>

                                            <th>{{ 'INVOICE_MODIFY.LBL_REMARKS' | translate }}</th>
                                            <th></th>

                                        </tr>
                                    </thead>
                                    <tbody>
                                        <ng-template ngFor let-item [ngForOf]="invoicetransactionDetails" let-i="index">


                                            <tr [ngClass]="i%2 !== 0?'even':'odd' ">
                                                <td *ngIf="serviceId==1" class="width40 text-center ">
                                                    <!-- <span class="expandable-trigger"
                                                        (click)=toggleExpandRow($event,i,item)>+</span> -->
                                                        <div class="product-count" (click)=toggleExpandRow($event,i,item)>
                                                            {{item.reportCount}}
                                                          </div>

                                                    <a style="color: blue;" triggers="mouseenter:mouseleave"
                                                        (click)="getBookingMoreInfo(bookingMoreInfo, item.bookingNo)"
                                                        class="right-link">
                                                        {{ 'INVOICE_MODIFY.LBL_MORE_INFO' | translate }}</a>

                                                </td>
                                                <td class="sticky-left-column width-40">
                                                    <a style="color: blue;" triggers="mouseenter:mouseleave"
                                                        (click)="navigateToBooking(item.bookingNo)" class="right-link">
                                                        {{item.bookingNo}}</a>
                                                    <span
                                                        *ngIf="item.customerBookingNo">/{{item.customerBookingNo}}</span>


                                                </td>
                                                <td class="width-40">
                                                    <a style="color: blue;" triggers="mouseenter:mouseleave"
                                                        (click)="navigateToQuotation(item.quotationNo)"
                                                        class="right-link">
                                                        {{item.quotationNo}}</a>
                                                </td>

                                                <td class="width-100"
                                                    *ngIf="item.serviceDateFrom == item.serviceDateTo">
                                                    {{item.serviceDateFrom}}</td>
                                                <td class="width-100"
                                                    *ngIf="item.serviceDateFrom != item.serviceDateTo">
                                                    {{item.serviceDateFrom}} -
                                                    {{item.serviceDateTo}}</td>

                                                <td class="width-140">{{item.serviceType}}</td>
                                                <td class="width-140">{{item.customer}}</td>
                                                <td class="width-140">{{item.supplier}}</td>
                                                <td class="width-140">{{item.factory}}</td>

                                                <td class="width-140">
                                                    {{item.factoryCountry}}/{{item.factoryProvince}}
                                                    <div>
                                                        <ng-template #factoryContent>
                                                            <div style="width: 200px;">
                                                                {{item.factoryCountry}}/{{item.factoryProvince}}/{{item.factoryCity}}/{{item.factoryCounty}}/{{item.factoryTown}}
                                                            </div>
                                                        </ng-template>
                                                        <a style="color: blue;" [ngbPopover]="factoryContent"
                                                            triggers="mouseenter:mouseleave" placement="right"
                                                            popoverTitle="Factory Location">
                                                            More...
                                                        </a>
                                                    </div>

                                                </td>

                                                <td *ngIf="serviceId==1" class="width-60">{{item.priceCategory}}</td>

                                                <td *ngIf="serviceId==1" class="width-100">{{item.totalBookingQty}}</td>

                                                <td *ngIf="serviceId==1" class="width-100">{{item.totalInspectedQty}}
                                                </td>

                                                <td *ngIf="serviceId==1" class="width-100">{{item.totalPresentedQty}}
                                                </td>

                                                <td>
                                                    <input min="0"
                                                       (change)="changeManday(item)" (paste)="onPaste($event,5)"
                                                       (keypress)="numericValidation($event)"
                                                       (input)="validateDecimal(item,_feeType.Manday)"
                                                        [(ngModel)]="item.manDay" class="width-100" type="number">
                                                </td>

                                                <td>
                                                    <input min="1" style="text-align: right;"   
                                                        (change)="changeManday(item)"                                                     
                                                        (input)="validateDecimal(item,_feeType.UnitPrice)"
                                                        [(ngModel)]="item.unitPrice" class="width-100" type="number">
                                                </td>

                                                <td>
                                                    <input min="1" style="text-align: right;"
                                                        (change)="calculateFeesTotal()"
                                                        (input)="validateDecimal(item,_feeType.InspectionFees)"
                                                        [disabled]="(item.isTravelExpense && !item.isInspectionFees)||invoiceBaseDetail.billMethod==billingMethod.ManDay"
                                                        [(ngModel)]="item.inspectionFees" class="width-100"
                                                        type="number">
                                                </td>

                                                <td>
                                                    <input min="1" style="text-align: right;"
                                                        (change)="calculateFeesTotal()"
                                                        (input)="validateDecimal(item,_feeType.TravelAirFees)"
                                                        [disabled]="item.isInspectionFees && !item.isTravelExpense"
                                                        [(ngModel)]="item.airCost" class="width-100" type="number">
                                                </td>

                                                <td>
                                                    <input min="1" style="text-align: right;"
                                                        (change)="calculateFeesTotal()"
                                                        (input)="validateDecimal(item,_feeType.TravelLandFees)"
                                                        [disabled]="item.isInspectionFees && !item.isTravelExpense"
                                                        [(ngModel)]="item.landCost" class="width-100" type="number">
                                                </td>

                                                <td>
                                                    <input min="1" style="text-align: right;"
                                                        (change)="calculateFeesTotal()"
                                                        (input)="validateDecimal(item,_feeType.OtherTravelFees)"
                                                        [disabled]="item.isInspectionFees && !item.isTravelExpense"
                                                        [(ngModel)]="item.travelOtherFees" class="width-100"
                                                        type="number">
                                                </td>

                                                <td>
                                                    <input min="1" style="text-align: right;"
                                                        (change)="calculateFeesTotal()"
                                                        [disabled]="item.isInspectionFees && !item.isTravelExpense"
                                                        (input)="validateDecimal(item,_feeType.HotelFees)"
                                                        [(ngModel)]="item.hotelCost" class="width-100" type="number">
                                                </td>

                                                <td>
                                                    <input min="1" style="text-align: right;"
                                                        (change)="calculateFeesTotal()"
                                                        (input)="validateDecimal(item,_feeType.OtherFees)"
                                                        [(ngModel)]="item.otherCost" class="width-100" type="number">
                                                </td>

                                                <td>
                                                    <input min="1" style="text-align: right;" [disabled]="true"
                                                        [(ngModel)]="item.extraFeeSubTotal" class="width-100"
                                                        type="number">
                                                </td>

                                                <td>
                                                    <input min="1" style="text-align: right;"
                                                        (change)="calculateFeesTotal()"
                                                        (input)="validateDecimal(item,_feeType.Discount)"
                                                        [(ngModel)]="item.discount" class="width-100" type="number">
                                                </td>

                                                <td>
                                                    <textarea [(ngModel)]="item.remarks"
                                                        class="width-180 textarea-products" type="text"></textarea>
                                                </td>

                                                <td>
                                                    <button
                                                        (click)="openDeleteInvoiceConfirm(item.id,item.bookingNo,deleteInvoice)"
                                                        class="secondary-cta x-small" style="margin-left:10px">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                </td>

                                            </tr>

                                            <ng-container>
                                                <ng-template [ngTemplateOutlet]="productListTemplate"
                                                    [ngTemplateOutletContext]="{ iteminfo: item, i:i}">
                                                </ng-template>
                                            </ng-container>


                                        </ng-template>

                                        <tr style="background-color: #f3f5fa !important">
                                            <td [attr.colspan]="columnSpan" class="invoiceFooterTotal">
                                                {{ 'INVOICE_MODIFY.LBL_SUB_TOTAL' | translate }}</td>
                                            <td>
                                                <input style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.inspectionFeesTotal" type="number">
                                            </td>
                                            <td>
                                                <input style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.airCostTotal" type="number">
                                            </td>
                                            <td>
                                                <input style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.landCostTotal" type="number">
                                            </td>
                                            <td>
                                                <input style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.otherTravelCostTotal" type="number">
                                            </td>
                                            <td>
                                                <input style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.hotelCostTotal" type="number">
                                            </td>
                                            <td>
                                                <input style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.otherCostTotal" type="number">
                                            </td>
                                            <td>
                                                <input class="width-100" style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.extraFeeSubTotal" type="number">
                                            </td>
                                            <td>
                                                <input class="width-100" style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.discountTotal" type="number">
                                            </td>

                                            <td></td>
                                            <td></td>
                                        </tr>

                                        <tr style="background-color: #f3f5fa !important">
                                            <td [attr.colspan]="columnSpan" class="invoiceFooterTotal">
                                                {{ 'INVOICE_MODIFY.LBL_TAX_TOTAL' | translate
                                                }}:({{invoiceBaseDetail.taxValue}})
                                            </td>
                                            <td>
                                                <input style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.inspectionFeesTaxTotal" type="number">
                                            </td>
                                            <td>
                                                <input style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.airCostTaxTotal" type="number">
                                            </td>
                                            <td>
                                                <input style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.landCostTaxTotal" type="number">
                                            </td>
                                            <td>
                                                <input style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.otherTravelCostTaxTotal" type="number">
                                            </td>
                                            <td>
                                                <input style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.hotelCostTaxTotal" type="number">
                                            </td>
                                            <td>
                                                <input class="width-100" style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.otherCostTaxTotal" type="number">
                                            </td>
                                            <td colspan="2">
                                                <input class="width-100" style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.extraFeeTax" type="number">
                                            </td>

                                            <td></td>
                                            <td></td>
                                        </tr>

                                        <tr class="sticky-bottom-row" style="background-color: #f3f5fa !important">
                                            <td [attr.colspan]="columnSpan" class="invoiceFooterTotal">
                                                {{ 'INVOICE_MODIFY.LBL_TOTAL_INVOICE_AMOUNT' | translate }}
                                                ({{invoiceBaseDetail.currency}})
                                            </td>
                                            <td colspan="10">
                                                <input class="width-100" style="text-align: right;" [disabled]="true"
                                                    [(ngModel)]="masterData.totalInvoiceFees" type="number">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>

                        <div class="col-sm-12">
                            <div class="row form-action-container">
                                <div class="col-sm-12">
                                    <button [disabled]="masterData.saveDataLoading"
                                        class="secondary-cta MarginR-20" (click)="openTemplatePopUp()">
                                        {{'COMMON.LBL_PREVIEW' | translate}}
                                        <span *ngIf="masterData.saveDataLoading">
                                            <i class="fa fa-refresh fa-spin" aria-hidden="true"></i>
                                        </span>
                                    </button>
                                    <button [disabled]="masterData.saveDataLoading" class="primary-cta MarginR-20"
                                        (click)="updateInvoiceDetails()">
                                        {{'COMMON.LBL_SAVE' | translate}}
                                        <span *ngIf="masterData.saveDataLoading">
                                            <i class="fa fa-refresh fa-spin" aria-hidden="true"></i>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </div>

        <ng-template #bookingMoreInfo let-modal>
            <div class="modal-header custom-modal-header">
                <h4 class="modal-title" id="modal-basic-title">
                    {{ 'INVOICE_MODIFY.LBL_BOOKING_INFORMATION' | translate }}</h4>
                <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body custom-modal-body">
                <div class="content-container schedule-allocation-container">
                    <div class="formPadding">
                        <div class="row">
                            <div class="col-sm-12 marginTop20 detail-column-container">
                                <div class="my-input-group col-lg-4">
                                    <label class="light" for="">{{ 'INVOICE_MODIFY.LBL_BRAND' | translate }}</label>
                                    <p class="input-value">{{bookingMoreInfoDetail.brands}}</p>
                                </div>
                                <div class="my-input-group col-lg-4">
                                    <label class="light" for="">{{ 'INVOICE_MODIFY.LBL_DEPARTMENT' | translate
                                        }}</label>
                                    <p class="input-value">{{bookingMoreInfoDetail.departments}}</p>
                                </div>
                                <div class="my-input-group col-lg-4">
                                    <label class="light" for="">{{ 'INVOICE_MODIFY.LBL_QC' | translate }}</label>
                                    <p class="input-value">{{bookingMoreInfoDetail.qcNames}}</p>
                                </div>
                            </div>

                            <div class="col-sm-12 marginTop20 detail-column-container">

                                <div class="my-input-group col-lg-4">
                                    <label class="light" for="">{{ 'INVOICE_MODIFY.LBL_COLLECTION' | translate
                                        }}</label>
                                    <p class="input-value">{{bookingMoreInfoDetail.collection}}</p>
                                </div>
                                <!-- <div class="my-input-group col-lg-4 padding-left tablet-padding-left">
                                    <label class="light" for="">{{ 'INVOICE_MODIFY.LBL_TOTAL_PRESENTED_QTY' | translate
                                        }}</label>
                                    <p class="input-value">{{bookingMoreInfoDetail.presentedQuantity}}</p>
                                </div> -->
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </ng-template>

        <ng-template #productListTemplate let-iteminfo="iteminfo" let-i="i">
            <tr class="expandable-row" [attr.data-expand-id]="'booking' + i">
                <td colspan="23">

                    <div class="content-container padding10">
                        <div class="table-container child-table" style="overflow-y: scroll;max-height:500px;">
                            <table class="pagination-table simple-table bordered">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th class="desktop-hide"></th>
                                        <th>{{ 'INVOICE_MODIFY.LBL_PRODUCT_ID' | translate }}</th>
                                        <th>{{ 'INVOICE_MODIFY.LBL_PRODUCT_DESC' | translate }}</th>
                                        <th> {{ 'INVOICE_MODIFY.LBL_PO_NUMBER' | translate }} </th>
                                        <th>{{ 'INVOICE_MODIFY.LBL_BOOKING_QTY' | translate }}</th>
                                        <th>{{ 'INVOICE_MODIFY.LBL_PRESENTED_QTY' | translate }}</th>
                                        <th>{{ 'INVOICE_MODIFY.LBL_INSPECTED_QTY' | translate }}</th>
                                        <th>{{ 'INVOICE_MODIFY.LBL_PRODUCT_CATEGORY' | translate }}</th>
                                        <th>{{ 'INVOICE_MODIFY.LBL_PRODUCT_SUB_CATEGORY' | translate }}</th>
                                        <th>{{ 'INVOICE_MODIFY.LBL_PRODUCT_SUB_CATEGORY2' | translate }}</th>

                                    </tr>
                                </thead>
                                <tbody>

                                    <tr *ngIf="iteminfo.isPlaceHolderVisible">
                                        <td>
                                            <div class="table-placeholder-block animate"></div>
                                        </td>
                                        <td>
                                            <div class="table-placeholder-block animate"></div>
                                        </td>
                                        <td>
                                            <div class="table-placeholder-block animate"></div>
                                        </td>
                                        <td>
                                            <div class="table-placeholder-block animate"></div>
                                        </td>
                                        <td>
                                            <div class="table-placeholder-block animate"></div>
                                        </td>
                                        <td>
                                            <div class="table-placeholder-block animate"></div>
                                        </td>
                                        <td>
                                            <div class="table-placeholder-block animate"></div>
                                        </td>
                                        <td>
                                            <div class="table-placeholder-block animate"></div>
                                        </td>
                                        <td>
                                            <div class="table-placeholder-block animate"></div>
                                        </td>
                                    </tr>

                                    <ng-template ngFor let-product [ngForOf]="iteminfo.productList" let-p="index">

                                        <tr>

                                            <td class="Center_Middle">{{p+1}}</td>

                                            <td class="width-140">
                                                {{product.productName}}
                                            </td>

                                            <td class="width-140">
                                                {{product.productDescription}}
                                            </td>
                                            <td class="width-60">
                                                {{product.poNumber}}
                                            </td>

                                            <td class="Center_Middle width-140">
                                                {{product.bookingQuantity}}
                                            </td>

                                            <td class="Center_Middle width-140">
                                                {{product.presentedQuantity}}
                                            </td>

                                            <td class="Center_Middle width-140">
                                                {{product.inspectionQuantity}}
                                            </td>

                                            <td class="width-140" *ngIf="!isQuotationPending">
                                                {{product.productCategory}}
                                            </td>
                                            <td class="width-140">
                                                {{product.productSubCategory}}
                                            </td>
                                            <td class="width-140">
                                                {{product.productSubCategory2}}
                                            </td>
                                        </tr>

                                    </ng-template>

                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-container child-table">
                            <span class="small"></span>
                            <span class="dark"></span>
                        </div>
                    </div>
                </td>
            </tr>
        </ng-template>


        <ng-template #deleteInvoice let-modal>
            <div class="modal-body">
                <div class="small-model">
                    <h2 class="title">{{ 'INVOICE_MODIFY.LBL_DELETE' | translate }} {{deleteBookingNo}} ?</h2>
                    <p>{{ 'INVOICE_MODIFY.LBL_DELETE_INVOICE_BOOKING' | translate }}</p>
                    <button class="secondary-cta" (click)="modal.dismiss('Cross click')">{{ 'COMMON.LBL_CONFIRMCANCEL' |
                        translate }}</button>
                    <button class="primary-cta" (click)="removeInvoiceBookingDetail(deleteInvoiceId);">{{
                        'COMMON.LBL_OK' | translate }}</button>
                </div>
            </div>
        </ng-template>

        <ng-template #invoiceToNewBooking let-modal>
            <div class="modal-header custom-modal-header">
                <h4 class="modal-title" id="modal-title">{{ 'QUOTATION.LBL_ORDERDETAILS' | translate }}</h4>
                <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body custom-modal-body">
                <div class="table-container">
                    <div class="row">
                        <div class="col-sm-3 col-md-3 col-lg-3">
                            <div class="my-input-group">
                                <label>{{ 'QUOTATION.LBL_BOOKNO' | translate }}</label>
                                <input [(ngModel)]="newInvoiceBookingRequest.bookingNumber" type="number" maxlength="10"
                                    placeholder="{{ 'QUOTATION.LBL_BOOKNO' | translate }}">
                                <!-- <div *ngIf="newInvoiceBookingRequest.bookingNumber!=null && newInvoiceBookingRequest.bookingNumber!=undefined && _customvalidationforbookid"
                                    class="invalid-feedback">
                                    <div>{{ 'BOOKING_SUMMARY.MSG_BOOKINGNO_ERROR' | translate }}</div>
                                </div> -->
                            </div>
                        </div>
                        <div class="col-sm-3 col-md-3 col-lg-3">
                            <div class="my-input-group">
                                <label class="required">{{ 'QUOTATION.LBL_STARTDATE' | translate }}</label>
                                <div class="calendar-wrapper">
                                    <input type="text" maxlength="10"
                                        [ngClass]="{ 'is-invalid':  !bookingvalidator.isValidIf('bookingStartDate',IsDateValidationRequired())}"
                                        readonly=readonly placeholder="{{ 'QUOTATION.LBL_STARTDATE' | translate }}"
                                        [(ngModel)]="newInvoiceBookingRequest.bookingStartDate" ngbDatepicker
                                        #fd="ngbDatepicker" (click)="fd.toggle()">
                                    <img src="assets/images/calendar-icon.svg" alt="" class="calendar-icon"
                                        (click)="fd.toggle()">
                                </div>
                                <div *ngIf="!bookingvalidator.isValidIf('bookingStartDate',IsDateValidationRequired())"
                                    class="invalid-feedback">
                                    <div *ngFor="let error of bookingvalidator.getErrors('bookingStartDate')">
                                        {{ error | translate }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3 col-md-3 col-lg-3">
                            <div class="my-input-group">
                                <label class="required">{{ 'QUOTATION.LBL_TODATE' | translate }}</label>
                                <div class="calendar-wrapper">
                                    <input type="text" maxlength="10"
                                        [ngClass]="{ 'is-invalid':  !bookingvalidator.isValidIf('bookingEndDate',IsDateValidationRequired())}"
                                        readonly=readonly placeholder="{{ 'QUOTATION.LBL_TODATE' | translate }}"
                                        [(ngModel)]="newInvoiceBookingRequest.bookingEndDate" ngbDatepicker
                                        #td="ngbDatepicker" (click)="td.toggle()">
                                    <img src="assets/images/calendar-icon.svg" alt="" class="calendar-icon"
                                        (click)="td.toggle()">
                                </div>
                                <div *ngIf="!bookingvalidator.isValidIf('bookingEndDate',IsDateValidationRequired())"
                                    class="invalid-feedback">
                                    <div *ngFor="let error of bookingvalidator.getErrors('bookingEndDate')">
                                        {{ error | translate }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3 col-md-3 col-lg-3 marginTop25">
                            <button id="btnSearch" class="primary-cta small" (click)="searchNewBookingToInvoice()">
                                {{ 'SUPPLIER_SUMMARY.LBL_SEARCH' | translate }}
                                <span *ngIf="bookingSearchLoading">
                                    <i class="fa fa-refresh fa-spin" aria-hidden="true"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                    <div class="table-container marginTop25 scroll-x" style="overflow-y:scroll;max-height:400px;"
                        #scrollableTablepopup *ngIf="orderDetails && orderDetails.length > 0">
                        <table class="pagination-table">
                            <thead>
                                <tr>
                                <tr>
                                    <th></th>
                                    <th>{{ 'QUOTATION.LBL_BOOKNO' | translate }}</th>
                                    <th *ngIf="serviceId==1">{{ 'INVOICE_MODIFY.LBL_BOOKING_QTY' | translate }}</th>
                                    <th>{{ 'INVOICE_MODIFY.LBL_SERVICE_DATE' | translate }}</th>
                                    <th>{{ 'INVOICE_MODIFY.LBL_CUSTOMER' | translate }}</th>
                                    <th>{{ 'INVOICE_MODIFY.LBL_SUPPLIER' | translate }}</th>
                                    <th>{{ 'INVOICE_MODIFY.LBL_FACTORY' | translate }}</th>
                                    <th>{{ 'QUOTATION.LBL_SERVICETYPE' | translate }}</th>
                                    <th *ngIf="serviceId==1">{{ 'INVOICE_MODIFY.LBL_SERVICE_PRICE_CATEGORY' | translate
                                        }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let item of orderDetails;let i = index">
                                    <td class="Center_Middle">
                                        <div class="styled-checkbox-container">
                                            <input type="checkbox" class="styled-checkbox" id="checkboxorder-{{i}}"
                                                [(ngModel)]="item.isChecked">
                                            <label for="checkboxorder-{{i}}"></label>
                                        </div>
                                    </td>
                                    <td>{{item.bookingId}}</td>
                                    <td *ngIf="serviceId==1">{{item.bookingQuantity}}</td>
                                    <td>{{item.serviceDate}}</td>
                                    <td>{{item.customerName}}</td>
                                    <td>{{item.supplierName}}</td>
                                    <td>{{item.factoryName}}</td>
                                    <td>{{item.serviceTypeName}}</td>
                                    <td *ngIf="serviceId==1">{{item.priceCategoryName}}</td>
                            </tbody>
                        </table>
                    </div>
                    <div class="no-result-table" *ngIf="noBookingForInvoice">
                        <img src="assets/images/no-data.png" alt="" class="icon">
                        <h4 class="title">
                            {{'QUOTATION.LBL_NO' | translate}}
                            {{'QUOTATION.MSG_NO_ITEM_FOUND' | translate}}
                        </h4>
                        <p>{{'COMMON.LBL_NODATA' | translate}} </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="primary-cta small" (click)="generateNewBookingInvoice()">
                    {{ 'INVOICE_MODIFY.LBL_GENERATE_INVOICE' | translate }}
                </button>
                <button type="button" class="secondary-cta small" (click)="modal.dismiss('cancel click')">
                    {{ 'QUOTATION.LBL_CONFIRMCANCEL' | translate }}
                </button>
            </div>
        </ng-template>


        <div class="loader-overlay" *ngIf="isInvoiceDataLoading">
            <div class="loader-container">
                <img src="assets/images/reload.svg" alt="">
                <span>{{'COMMON.LBL_LOADER' | translate}}</span>
            </div>
        </div>

    </div>
</div>

<ng-template #invoicePreviewTemplate let-modal>
    <app-invoice-preview (closeInvoicePreview)="closeInvoicePreview()" [invoicePreviewModel]="invoicePreviewRequest">
    </app-invoice-preview>
</ng-template>
